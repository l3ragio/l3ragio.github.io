name: ZMediumToMarkdown

on:
  workflow_dispatch:
  push:
  schedule:
    - cron: '10 1 15 * *' # Monthly sync

permissions:
  contents: write

jobs:
  fetch_and_sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.3
          bundler-cache: true

      - name: Add feedjira to Gemfile
        run: |
          echo "gem 'feedjira'" >> Gemfile
          bundle install

      - name: Run ZMediumToMarkdown Bot
        uses: ZhgChgLi/ZMediumToMarkdown@main
        with:
          command: >
            --cookie_uid ${{ secrets.MEDIUM_COOKIE_UID }}
            --cookie_sid ${{ secrets.MEDIUM_COOKIE_SID }}
            -j ${{ env.MEDIUM_USER }}

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick

      - name: Generate OG preview images for Visual Stories
        run: |
          mkdir -p assets/og
          ruby scripts/generate_visual_story_og.rb

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "Update fetched Medium posts + OG previews"
          branch: main
          push_options: "--force-with-lease"
