<!doctype html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Unpacking Malware" /><meta name="author" content="Davide Bragetti" /><meta property="og:locale" content="en" /><meta name="description" content="In manual and automated ways" /><meta property="og:description" content="In manual and automated ways" /><link rel="canonical" href="https://l3ragio.github.io/posts/685de7093e5/" /><meta property="og:url" content="https://l3ragio.github.io/posts/685de7093e5/" /><meta property="og:image" content="https://l3ragio.github.io/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-29T01:12:06+02:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://l3ragio.github.io/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" /><meta property="twitter:title" content="Unpacking Malware" /><meta name="twitter:site" content="@l3rag1" /><meta name="twitter:creator" content="@Davide Bragetti" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Davide Bragetti"},"dateModified":"2025-03-26T13:50:42+01:00","datePublished":"2022-08-29T01:12:06+02:00","description":"In manual and automated ways","headline":"Unpacking Malware","image":"https://l3ragio.github.io/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://l3ragio.github.io/posts/685de7093e5/"},"url":"https://l3ragio.github.io/posts/685de7093e5/"}</script><title>Unpacking Malware |</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content=""><meta name="application-name" content=""><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tocbot@4.32.2/dist/tocbot.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js,npm/tocbot@4.32.2/dist/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=true" ></script><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/img/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/"></a><p class="site-subtitle fst-italic mb-0"></p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/visual-stories/" class="nav-link"> <i class="fa-fw 📚"></i> <span>VISUAL STORIES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw "></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/l3ragio" aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/l3rag1" aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fa-brands fa-x-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['bragettidavide','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Unpacking Malware</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Unpacking Malware</h1><p class="post-desc fw-light mb-4">In manual and automated ways</p><div class="post-meta text-muted"> <span> Posted <time data-ts="1661728326" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 29, 2022 </time> </span> <span> Updated <time data-ts="1742993442" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 26, 2025 </time> </span><div class="mt-3 mb-3"> <a href="/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" class="popup img-link preview-img shimmer"><img src="/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1457 words" > <em>8 min</em> read</span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Unpacking Malware</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Unpacking Malware</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h3 id="unpacking-malware"><span class="me-2">Unpacking Malware</span><a href="#unpacking-malware" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="in-manual-and-automated-ways"><span class="me-2">In manual and automated ways</span><a href="#in-manual-and-automated-ways" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Initially, Packers were just software born to protect developers’ intellectual property by hiding the inner mechanisms of software. Nowadays, cybercriminals use them too to make malicious executables avoiding static detection by hiding the operations they will perform. Many free packers are used to obfuscate malware, such as UPX, PE Protector, and MPRESS, to name a few, but malware developers also take care of this aspect by building custom routines to pack and unpack their precious creation. These routines usually go by the name of Crypters, and unlike commercial packers, they are not “general-purpose”, in that their unique objective is to pack and unpack the payload they have been created for. There exists a similarity between encryption and packing; both enhance the entropy of the target data, avoid bit-sequence repetition, and obtain a result that looks like random junk. The difference is that packing usually expects data compression, so a reduction of the size of the executable.</p><p>After being packed, a target executable is divided into at least two parts: an <em>unpacking stub</em> , also called an “envelope”, and the actual compressed data.</p><p><a href="/assets/685de7093e5/1*gvcExt7yMX00VxKRCVr5bQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*gvcExt7yMX00VxKRCVr5bQ.png" alt="" loading="lazy"></a></p><p>When started, a packed file would execute the unpacking stub that performs operations such as allocating new space, decrypting and copying further instructions, running those instructions, and so on, until the data composes the original file and can finally be executed.</p><p><a href="/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*OGxGySb6sO2ATFo9cf15KA.png" alt="" loading="lazy"></a></p><p>Malware analysts developed several techniques to cope with packing, ranging from fully manual, semi-automated, and fully automated.</p><h4 id="1-locating-tail-or-section-jumps"><span class="me-2">1: Locating Tail (or Section) Jumps</span><a href="#1-locating-tail-or-section-jumps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Packers like UPX and MPRESS have in common that after the decompression routine, there is usually an inter-section jump, so an instruction that moves the Instruction Pointer from one section to another, this could be accomplished by a jump or equivalent instruction, (like push aex, return) .</p><h4 id="2-intercepting-signature-functions"><span class="me-2">2: Intercepting “Signature-Functions”</span><a href="#2-intercepting-signature-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The packed executable often injects code in its or others’ process address space using a variety of Windows API calls. Tracing manually or putting break-points on these function calls is usually sufficient to locate the unpacked payloads. This method can also identify which <em>covert execution</em> technique the malware could attempt to use. Of particular interest are all the API calls that can be used for <em>Getting the handle</em> on the target process and for <em>Allocating</em> , <em>Copying</em> , <em>Altering</em> <em>Permissions</em> , and <em>Triggering</em> the execution of memory regions.</p><h4 id="3-using-automated-tools"><span class="me-2">3: Using Automated Tools</span><a href="#3-using-automated-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Malware analysts used their wits to build services able to automatically dissect and unpack malware. Examples of these are from the work of @hasherezade <a href="https://github.com/hasherezade/pe-sieve/releases" target="_blank">pe-sieve</a> / <a href="https://github.com/hasherezade/hollows_hunter" target="_blank">hollow-hunter</a> and <a href="https://github.com/hasherezade/mal_unpack" target="_blank">mal_unpack</a> , or <a href="https://www.unpac.me/#/" target="_blank">unpac.me</a> , The founding Idea used by these kind tools is diverse, for example in the case of pe-sieve and derivates the main idea is</p><blockquote><p>to detect code overwritten in memory by comparing it with the executable on disk</p></blockquote><p>while <a href="https://docs.panda.re/" target="_blank">pandare</a> , uses whole system analysis to spot changes in entropy in processes and dump the corresponding memory sections.</p><h3 id="the-sample"><span class="me-2">The Sample</span><a href="#the-sample" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this blog post we are going to unpack a sample of the <strong>RedLineStealer</strong> malware you can find at this <a href="https://bazaar.abuse.ch/sample/3215decffc40b3257ebeb9b6e5c81c45e298a020f33ef90c9418c153c6071b36/" target="_blank">link</a> . The use of a VM is highly recomanded, since in the <strong><em>Automated Tools</em></strong> chapter we need to start an infection, possibly collecting second stage payloads from the internet.</p><blockquote><p><strong>MD5</strong> :</p></blockquote><blockquote><p>618ea7b0e2a26f3c6db0a8664c63fc6f</p></blockquote><blockquote><p><strong>SHA256</strong> : 3215decffc40b3257ebeb9b6e5c81c45e298a020f33ef90c9418c153c6071b36</p></blockquote><p><strong>Pestudio</strong> is not able to recover any function imported by the sample, a sign that it is in fact packed.</p><p><a href="/assets/685de7093e5/1*BlwXL3HTglmlFWJ2wyMYEQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*BlwXL3HTglmlFWJ2wyMYEQ.png" alt="" loading="lazy"></a></p><p>Looking in the file-header we can notice the usual name used by UPX for its sections.</p><p><a href="/assets/685de7093e5/1*j3f55tpF6k3CDpX-sxfKEQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*j3f55tpF6k3CDpX-sxfKEQ.png" alt="" loading="lazy"></a></p><h4 id="locating-tail-or-section-jumps"><span class="me-2">Locating Tail (or Section) Jumps</span><a href="#locating-tail-or-section-jumps" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>We can expect the Unpacking Stub to jump into another section for executing the unpacked code, so we are searching for a jump instruction that could also be indirect but, in our case with UPX, will be direct. In this case, we can let our eyes help us by looking at the code-graph arrows between code blocks.</p><p>In particular, we are searching for jumps from the entry point section to any other section, and we can check which section the program starts by looking at the Functions window. Instead, in in the Segments window (View→Open Subviews → Segments), we can learn what the address ranges for the sections are, which is a piece of very precious information for our search.</p><p><a href="/assets/685de7093e5/1*rxyTH8G3CMB4dG_s01ZlIQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*rxyTH8G3CMB4dG_s01ZlIQ.png" alt="" loading="lazy"></a></p><p>We can see that section UPX1, where we are now, is not that huge (from 729000 to 8E5000), so we might expect the TAIL JUMP into another section. By the end of the graph representation of <em>sub_8E4800</em> method, we can notice the direct jump to an address in the UPX0 section.</p><p><a href="/assets/685de7093e5/1*6WEwmhDjhBkaDXxkoIsuHw.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*6WEwmhDjhBkaDXxkoIsuHw.png" alt="" loading="lazy"></a></p><p>From a rapid look to the target address we see very clearly that we are at the end of the UPX0 section, and the disassembler was not able to decode any instruction in it.</p><p><a href="/assets/685de7093e5/1*cNNxNnMvFSOzORVgjjen0w.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*cNNxNnMvFSOzORVgjjen0w.png" alt="" loading="lazy"></a></p><p>From a quick look at the target address, we clearly see that we are at the end of the UPX0 section, and the disassembler could not decode any instructions. We can put a breakpoint on that jump and let the debugger run to validate this hypothesis. After the breakpoint is hit, we make IDA re-analyze the program with the menu option: Options — General — Analysis — Reanalyze Program — Ok.</p><p><a href="/assets/685de7093e5/1*ulm7eIOTftJYtTSDnmkktA.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*ulm7eIOTftJYtTSDnmkktA.png" alt="" loading="lazy"></a></p><p>Now it’s time to use Scylla to dump the memory and reconstruct the IAT. Open Scylla and select the process IDA is debugging</p><p><a href="/assets/685de7093e5/1*xgSXA2hAtb-YW-QJAIEVcw.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*xgSXA2hAtb-YW-QJAIEVcw.png" alt="" loading="lazy"></a></p><p>Then set the Original Entry Point (OEP) to the target address of the tail jump (45FDF0), or even of the tail jump instruction itself, then press IAT Autosearch and Get Imports,</p><p><a href="/assets/685de7093e5/1*DZ3Q3zaNXezwkUnoP15Zgw.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*DZ3Q3zaNXezwkUnoP15Zgw.png" alt="" loading="lazy"></a></p><p>Finally, we can press <em>Dump</em> to save the new PE and <em>Fix Dump</em> to adjust the raw size. Finally, by opening the dumped file, we can recognize the main routines of <strong>RedLineStealer.</strong></p><p><a href="/assets/685de7093e5/1*9hQbiXyDDR-0iPJUXQ0dvA.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*9hQbiXyDDR-0iPJUXQ0dvA.png" alt="" loading="lazy"></a></p><h4 id="intercepting-signature-functions"><span class="me-2">Intercepting “Signature-Functions”</span><a href="#intercepting-signature-functions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>This method could be thought of as a general method for debugging malware searching for payloads, which could be either PEs, DLLs, or Shellcodes.</p><p>Depending on the Process Injection Technique we are looking for, we would put breakpoints on different sets of API calls. Examples could be setting breakpoints on <em>OpenProcess</em> , <em>VirtualAllocEx</em> , <em>WriteProcessMemory,</em> and <em>CreateRemoteThread</em> for <strong>process injection</strong> , or on <em>CreateProcess</em> , <em>ZwCreateSection</em> , <em>ZwQueryInformationProcess</em> , <em>ReadProcessMemory</em> , <em>ZwMapViewOfSection</em> , <em>GetCurrentProcess</em> , <em>WriteprocessMemory,</em> and <em>ResumeThread</em> for <strong>Process Hollowing.</strong></p><p>In our case, we could limit the search to <em>LocalAlloc, VirtualAlloc</em> , <em>VirtualProtect</em> , and <em>CreateProcessInternalW,</em> hoping that UPX will resolve and use these dynamically. For doing it, we use x64dbg for opening the sample, run until the EntryPoint and add the breakpoints using the console.</p><blockquote><p><strong><em>bp LocalAlloc</em></strong></p></blockquote><blockquote><p><strong><em>bp VirtualAlloc</em></strong></p></blockquote><blockquote><p><strong><em>bp VirtualProtect</em></strong></p></blockquote><blockquote><p><strong><em>bp CreateProcessInternalW</em></strong></p></blockquote><p>In this case, with UPX this method is not that fruitful, so we will see it better in a later post.</p><h4 id="using-automated-tools"><span class="me-2">Using Automated Tools:</span><a href="#using-automated-tools" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To demonstrate the power of automated tools, we will use <a href="https://github.com/hasherezade/pe-sieve/releases" target="_blank">pe-sieve</a> . You can install it using chocolately:</p><blockquote><p>choco install pesieve</p></blockquote><p>After downloading the sample, we can run it so that we can take note of the PID.</p><p><a href="/assets/685de7093e5/1*eHf2guwgoQNDWhSM2RACUw.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*eHf2guwgoQNDWhSM2RACUw.png" alt="" loading="lazy"></a></p><p>Next, we run pe-sieve, specifying the /pid and /imp arguments used to target the desired process and attempt to reconstruct the IAT.</p><blockquote><p>pe-sieve.exe /pid 192 /imp 5</p></blockquote><p>Pe-sieve is going to create a folder with the memory dumps it spotted during the analysis and a JSON file with the result:</p><p><a href="/assets/685de7093e5/1*qQ0AmscvmozmrF4iIIC1GA.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*qQ0AmscvmozmrF4iIIC1GA.png" alt="" loading="lazy"></a></p><p>Comparing the sample with the Dump, we can observe how the raw size of section UPX0 is changed from 0 to 32800 bytes.</p><p><a href="/assets/685de7093e5/1*S3g_xellRIphXXji93M09g.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*S3g_xellRIphXXji93M09g.png" alt="" loading="lazy"></a></p><p>Looking at the imports, we can observe that the IAT reconstruction process was so successful that we now also have visibility of the functions the malware resolves dynamically.</p><p><a href="/assets/685de7093e5/1*KmoxgVklHF72noJVp3mRbw.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*KmoxgVklHF72noJVp3mRbw.png" alt="" loading="lazy"></a></p><p>To debug the sample, we need to fix the dumped sample’s entry point and set the sections as executable. For the first actions, we can use <a href="https://github.com/hasherezade/tiny_tracer" target="_blank">tiny_tracer</a> , which will help us to track the section jumps. Right-clicking on the sample and selecting “Run with PIN (Tiny Tracer)” , will start to collect some execution artifacts, saving them into a “.tag” file that we can open with <em>BareTail</em> .</p><p><a href="/assets/685de7093e5/1*4SyuInQSGy9kS2roD31vRg.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*4SyuInQSGy9kS2roD31vRg.png" alt="" loading="lazy"></a></p><p>So we can adjust the entry point.</p><p><a href="/assets/685de7093e5/1*cJ9x3NkuXsOVm5MLbE-FZQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*cJ9x3NkuXsOVm5MLbE-FZQ.png" alt="" loading="lazy"></a></p><p>Set both UPX0 and UPX1 as executable, and save the adjusted Dump.</p><p><a href="/assets/685de7093e5/1*D_t__NR8PV6wkAeNGl5CsQ.png" class="popup img-link shimmer"><img src="/assets/685de7093e5/1*D_t__NR8PV6wkAeNGl5CsQ.png" alt="" loading="lazy"></a></p><p>Finally, we have a working unpacked executable that can be debugged.</p><h3 id="conclusions"><span class="me-2">Conclusions</span><a href="#conclusions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In this post, we went through several ways of unpacking a <strong>RedLineStealer</strong> sample compressed with UPX, ranging from complete static code analysis with IDA to almost fully automated with PE-sieve. For more sophisticated packers, different procedures might be needed. Hopefully, leveraging the power of many RE Engines like Ghidra, IDA, and BinaryNinja, that offer API access to their database to automate operation, even beginner analysts can tackle the unpacking of even more complex obfuscators.</p><h4 id="further-readings"><span class="me-2">Further Readings:</span><a href="#further-readings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p><a href="https://web.archive.org/web/20241215175113/https://deluks2006.github.io/posts/snowy-days-and-the-malware-packing-ways/" target="_blank">Snowy Days &amp; The Malware Packing Ways | Magic Bytes</a></p><h4 id="references"><span class="me-2">References:</span><a href="#references" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><blockquote><p><a href="https://www.oreilly.com/library/view/learning-malware-analysis/9781788392501/820e38b0-43c1-40d0-93df-3b4d66da91a8.xhtml" target="_blank">https://www.oreilly.com/library/view/learning-malware-analysis/9781788392501/820e38b0-43c1-40d0-93df-3b4d66da91a8.xhtml</a></p></blockquote><blockquote><p><a href="https://marcoramilli.com/2020/10/09/how-to-unpack-malware-personal-notes/" target="_blank">https://marcoramilli.com/2020/10/09/how-to-unpack-malware-personal-notes/</a></p></blockquote><blockquote><p><a href="https://twitter.com/mehunhoff/status/1562812877966192643" target="_blank">https://twitter.com/mehunhoff/status/1562812877966192643</a></p></blockquote><blockquote><p><a href="https://speakerdeck.com/hshrzd/pe-sieve-detecting-hooking-and-code-implants?slide=30" target="_blank">https://speakerdeck.com/hshrzd/pe-sieve-detecting-hooking-and-code-implants?slide=30</a></p></blockquote><blockquote><p><a href="https://www.youtube.com/watch?v=eTt3QU0F7V0" target="_blank">https://www.youtube.com/watch?v=eTt3QU0F7V0</a></p></blockquote><blockquote><p><a href="https://corsidilaurea.uniroma1.it/it/view-course-details/2019/29389/20200316152528/0323bed7-8fbd-40a4-8a68-0471e78c8d2e/fe6d2256-d208-4e3e-8d34-9cbd9eb7fbe8/5121d76f-8076-418c-8ab4-57b191fede2a/52aa4642-de9c-4e48-bf7c-6e9eb991e862?guid_cv=fe6d2256-d208-4e3e-8d34-9cbd9eb7fbe8&amp;current_erogata=0323bed7-8fbd-40a4-8a68-0471e78c8d2e" target="_blank">1055681 — MALWARE ANALYSIS AND INCIDENT FORENSICS | Catalogo dei Corsi di studio</a></p></blockquote><p><em><a href="https://medium.com/@dbragetti/unpacking-malware-685de7093e5" target="_blank">Post</a> converted from Medium by <a href="https://github.com/ZhgChgLi/ZMediumToMarkdown" target="_blank">ZMediumToMarkdown</a>.</em></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories//"></a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/malware-analysis/" class="post-tag no-text-decoration" >malware-analysis</a> <a href="/tags/unpacking/" class="post-tag no-text-decoration" >unpacking</a> <a href="/tags/upx/" class="post-tag no-text-decoration" >upx</a> <a href="/tags/reverse-engineering/" class="post-tag no-text-decoration" >reverse-engineering</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Unpacking%20Malware%20-%20&url=https%3A%2F%2Fl3ragio.github.io%2Fposts%2F685de7093e5%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fa-brands fa-square-x-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Unpacking%20Malware%20-%20&u=https%3A%2F%2Fl3ragio.github.io%2Fposts%2F685de7093e5%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fl3ragio.github.io%2Fposts%2F685de7093e5%2F&text=Unpacking%20Malware%20-%20" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/posts/685de7093e5/">Unpacking Malware</a><li class="text-truncate lh-lg"> <a href="/posts/a7953a82fd2b/">Kerberos</a><li class="text-truncate lh-lg"> <a href="/posts/393bf888b4e8/">Choose Your Words Carefully in the Era of Peace, the Era of Silence</a><li class="text-truncate lh-lg"> <a href="/posts/dacd4e915676/">Auto-GPT — Welcome to the Botnet: Malware and Existential Threats of Autonomous, LLM-Powered, C&C</a><li class="text-truncate lh-lg"> <a href="/posts/e3a6a1939162/">Babuk v4 Ransomware</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware-analysis/">malware-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware/">malware</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">active-directory</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">ai</a> <a class="post-tag btn btn-outline-primary" href="/tags/artificial-intelligence/">artificial-intelligence</a> <a class="post-tag btn btn-outline-primary" href="/tags/asymmetric-encryption/">asymmetric-encryption</a> <a class="post-tag btn btn-outline-primary" href="/tags/auto-gpt/">auto-gpt</a> <a class="post-tag btn btn-outline-primary" href="/tags/babuk/">babuk</a> <a class="post-tag btn btn-outline-primary" href="/tags/colors/">colors</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/posts/e3a6a1939162/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1660567905" data-df="ll" > Aug 15, 2022 </time><h4 class="pt-0 my-2">Babuk v4 Ransomware</h4><div class="text-muted"><p>Background summary and technical sample analysis</p></div></div></a></article><article class="col"> <a href="/posts/a7953a82fd2b/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1740757752" data-df="ll" > Feb 28, 2025 </time><h4 class="pt-0 my-2">Kerberos</h4><div class="text-muted"><p>Just another introduction to Kerberos</p></div></div></a></article><article class="col"> <a href="/posts/393bf888b4e8/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1724432927" data-df="ll" > Aug 23, 2024 </time><h4 class="pt-0 my-2">Choose Your Words Carefully in the Era of Peace, the Era of Silence</h4><div class="text-muted"><p>Imagine an ideal world where pure happiness pervades all existence — a world where joy is so inherent that you don’t even need to think…</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/posts/e3a6a1939162/" class="btn btn-outline-primary" aria-label="Older" ><p>Babuk v4 Ransomware</p></a> <a href="/posts/4c7f612584c6/" class="btn btn-outline-primary" aria-label="Newer" ><p>Diffie-Hellman Key Exchange</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://x.com/l3rag1">Davide Bragetti</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.<br/> Automatically sync posts from Medium with <a href="https://zhgchg.li/posts/en-medium-to-jekyll/" target="_blank">ZhgChg.Li</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/cryptography/">cryptography</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware-analysis/">malware-analysis</a> <a class="post-tag btn btn-outline-primary" href="/tags/malware/">malware</a> <a class="post-tag btn btn-outline-primary" href="/tags/active-directory/">active-directory</a> <a class="post-tag btn btn-outline-primary" href="/tags/ai/">ai</a> <a class="post-tag btn btn-outline-primary" href="/tags/artificial-intelligence/">artificial-intelligence</a> <a class="post-tag btn btn-outline-primary" href="/tags/asymmetric-encryption/">asymmetric-encryption</a> <a class="post-tag btn btn-outline-primary" href="/tags/auto-gpt/">auto-gpt</a> <a class="post-tag btn btn-outline-primary" href="/tags/babuk/">babuk</a> <a class="post-tag btn btn-outline-primary" href="/tags/colors/">colors</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
